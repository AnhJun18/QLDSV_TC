USE [QLDSV_TC]
GO
/****** Object:  StoredProcedure [dbo].[SP_CHANGEPASS]    Script Date: 5/17/2022 1:45:27 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_CHANGEPASS] @LOGIN nchar(10), @PASSOLD nvarchar(40), @PASSNEW nvarchar(40)
 AS
 BEGIN
	 IF EXISTS ( SELECT 1 FROM SYS.sql_logins WHERE NAME = @LOGIN )
		BEGIN
			declare @SQLSTR nvarchar(200)
			Set @SQLSTR = 'ALTER LOGIN '+@LOGIN+' WITH PASSWORD= ' +QUOTENAME(@PASSNEW,'''')+ ' OLD_PASSWORD = '+QUOTENAME(@PASSOLD,'''')
			exec(@SQLSTR)
		END
	ELSE
	   Raiserror('Sai Mật Khẩu', 12, 1)

 END
GO
/****** Object:  StoredProcedure [dbo].[SP_CHANGEPASS_FOR_SV]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_CHANGEPASS_FOR_SV] @LOGIN nchar(10), @PASSOLD nvarchar(40), @PASSNEW nvarchar(40)
 AS
 BEGIN
   /* Phải bỏ sp đổi mật khẩu cho sv riêng vì nếu dùng chung vs đoỏi mật khẩu của giáo viên thì bị lỗi khi đưa xuống site 3
   vì site 3 ko có mật khẩu sinh viên*/
	 IF EXISTS ( SELECT 1 FROM SINHVIEN WHERE SINHVIEN.MASV = @LOGIN AND SINHVIEN.PASSWORD = @PASSOLD )
	   BEGIN
	      UPDATE SINHVIEN
		  SET SINHVIEN.PASSWORD = @PASSNEW
		  WHERE SINHVIEN.MASV = @LOGIN
		  RETURN;
	   END
	ELSE
	   Raiserror('Sai Mật Khẩu', 12, 1)

 END
GO
/****** Object:  StoredProcedure [dbo].[SP_CHECK_DANGNHAP]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_CHECK_DANGNHAP]
@TENLOGIN NVARCHAR (50)
AS
BEGIN
	DECLARE @TENUSER NVARCHAR(50)
	SELECT @TENUSER=NAME FROM sys.sysusers WHERE sid = SUSER_SID(@TENLOGIN)
	SELECT USERNAME = @TENUSER,
		HOTEN = (SELECT HO+ ' '+ TEN FROM GIANGVIEN WHERE MAGV = @TENUSER ),
		TENNHOM= NAME
			FROM sys.sysusers
				WHERE UID = (SELECT GROUPUID
					FROM SYS.SYSMEMBERS
						WHERE MEMBERUID= (SELECT UID FROM sys.sysusers
							WHERE NAME=@TENUSER))
END
GO
/****** Object:  StoredProcedure [dbo].[SP_CHECK_LOGIN_SV]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_CHECK_LOGIN_SV]
@TENLOGIN NVARCHAR (50), @MASV NCHAR(10), @PASS NVARCHAR(40)
AS
BEGIN
	IF EXISTS(SELECT * FROM SINHVIEN SV WHERE SV.MASV=@MASV AND SV.PASSWORD=@PASS)
	BEGIN
		DECLARE @TENUSER NVARCHAR(50)
		SELECT @TENUSER=NAME FROM sys.sysusers WHERE sid = SUSER_SID(@TENLOGIN)

		SELECT MASV=@MASV, HOTEN=(SELECT HO+ ' '+ TEN FROM SINHVIEN WHERE MASV = @MASV ),
			TENNHOM=(SELECT NAME
			FROM sys.sysusers
				WHERE UID = (SELECT GROUPUID
					FROM SYS.SYSMEMBERS
						WHERE MEMBERUID= (SELECT UID FROM sys.sysusers
							WHERE NAME=@TENUSER)))
	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_CHECKID]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_CHECKID]
@ID NCHAR(10),
@Type NCHAR(20)
AS
BEGIN 
    
	-- LOP
	IF(@Type = 'MALOP')
	BEGIN
		IF EXISTS(SELECT * FROM dbo.LOP WHERE dbo.LOP.MALOP = @ID)
				RETURN 1;--Mã LOP tồn tại ở phân hiện tại
		 IF EXISTS(SELECT * FROM LINK1.QLDSV_TC.dbo.LOP AS LOP WHERE LOP.MALOP = @ID)
			RETURN 2; --Mã Lớp tồn tại ở phân mãnh khác
	END

	 --MON HOC
	IF(@Type = 'MAMONHOC')
	BEGIN
		IF EXISTS(SELECT * FROM dbo.MONHOC AS MH WHERE MH.MAMH = @ID)
		RETURN 1;
	END

	 --SINH VIEN
	IF(@Type = 'MASV')
	BEGIN
	 IF EXISTS(SELECT * FROM dbo.SINHVIEN WHERE dbo.SINHVIEN.MASV = @ID)
			RETURN 1; -- Mã tồn tại ở phân mãnh hiện tại
	 IF EXISTS(SELECT * FROM LINK1.QLDSV_TC.dbo.SINHVIEN AS SV WHERE SV.MASV = @ID)
		RETURN 2; --Mã tồn tại ở phân mãnh khác
	END

	 RETURN 0 --Không bị trùng được thêm
END


CREATE PROCEDURE [dbo].[SP_CHECKNAME]
@Name NVARCHAR(200),
@Type NVARCHAR(50)
AS
BEGIN
	--Kiểm tra Table lop của server hiện tại
	IF(@Type = 'TENLOP')
	BEGIN
		IF EXISTS(SELECT * FROM dbo.LOP WHERE dbo.LOP.TENLOP = @Name)
			RETURN 1; -- @name bị trùng  ở phân mãnh hiện tại
	
		ELSE IF EXISTS(SELECT * FROM LINK1.QLDSV_TC.dbo.LOP AS LOP WHERE LOP.TENLOP = @Name)
			RETURN 2;	--@name bị trùng ở phân mãnh  khác
	END

	IF(@Type = 'TENMONHOC')
	BEGIN
		IF EXISTS(SELECT * FROM dbo.MONHOC WHERE TENMH = @Name)
		RETURN 1;
	END
	
	RETURN 0	
END


GO
/****** Object:  StoredProcedure [dbo].[SP_DKY_LTC]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[SP_DKY_LTC]
@MALTC int,
@MASV nchar(10)
AS
BEGIN 
  IF EXISTS ( SELECT * FROM DANGKY WHERE MALTC=@MALTC AND MASV=@MASV AND HUYDANGKY=1)
    BEGIN 
		UPDATE DANGKY 
		SET HUYDANGKY=0
		WHERE MALTC=@MALTC AND MASV=@MASV
	END
  ELSE
	BEGIN
		INSERT INTO DANGKY(MALTC,MASV) VALUES (@MALTC,@MASV)
	END

END
GO
/****** Object:  StoredProcedure [dbo].[SP_DSDKMH]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create PROCEDURE [dbo].[SP_DSDKMH] @NienKhoa nchar(9), @HocKy int, @Nhom int,@MonHoc nchar(10)
as
BEGIN
declare @LOPTINCHI int
select @LOPTINCHI= MALTC 
from LOPTINCHI JOIN MONHOC ON LOPTINCHI.MAMH = MONHOC.MAMH
where LOPTINCHI.NIENKHOA = @NienKhoa AND LOPTINCHI.HOCKY = @HocKy AND LOPTINCHI.NHOM = @Nhom
AND MONHOC.MAMH = @MonHoc 
select @LOPTINCHI as LOPTC, SINHVIEN.MASV,HOTEN=HO+' '+TEN,DIEM_CC,DIEM_GK,DIEM_CK,DIEM_TK= DIEM_CC*0.1 + DIEM_GK*0.3 + DIEM_CK*0.6 
from DANGKY JOIN SINHVIEN ON  DANGKY.MASV = SINHVIEN.MASV
where DANGKY.MALTC = @LOPTINCHI AND HUYDANGKY = 0
END
GO
/****** Object:  StoredProcedure [dbo].[SP_GET_CTDONG_HOCPHI]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_GET_CTDONG_HOCPHI]
@MASV NCHAR(10),@NIENKHOA NCHAR(9), @HOCKY INT
AS
	BEGIN 
		SELECT NGAYDONG,SOTIENDONG FROM CT_DONGHOCPHI
		WHERE MASV=@MASV AND NIENKHOA=@NIENKHOA AND @HOCKY=HOCKY
	END
GO
/****** Object:  StoredProcedure [dbo].[SP_GET_HOCKY]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
create proc [dbo].[SP_GET_HOCKY] @NIENKHOA nchar(9)  as 
select HOCKY from LOPTINCHI where NIENKHOA= @NIENKHOA group by HOCKY

GO
/****** Object:  StoredProcedure [dbo].[SP_GET_HOCPHI]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_GET_HOCPHI]
@MASV NCHAR(10)
AS
IF exists (select 1 from SINHVIEN a where a.MASV=@MASV)
	BEGIN 
		SELECT hp.NIENKHOA,hp.HOCKY,hp.HOCPHI, DADONG=isnull((select SUM(ct.SOTIENDONG)),0)  
		FROM 
		(select * from HOCPHI WHERE MASV=@MASV) hp left join
		(select * from CT_DONGHOCPHI WHERE MASV=@MASV) ct
		on hp.NIENKHOA=CT.NIENKHOA  AND HP.HOCKY=CT.HOCKY
		GROUP BY hp.NIENKHOA,hp.HOCKY,hp.HOCPHI
		order by hp.NIENKHOA,hp.HOCKY asc
		
	END
ELSE
  BEGIN 
    raiserror('Sinh Vien Không Tồn Tại',16,1);
  END
GO
/****** Object:  StoredProcedure [dbo].[SP_GET_LISTLOPTINCHI_DADKI]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_GET_LISTLOPTINCHI_DADKI]
@Nienkhoa nchar(9),
@Hocky int,
@MaSV nchar(10)
as
BEGIN
	
select  MALTC,MAMH,TENMH=(select TENMH from MONHOC a where a.MAMH=ltc.MAMH),
		NHOM=ltc.NHOM, GIANGVIEN=(SELECT gv.HO+' '+gv.TEN FROM GIANGVIEN gv WHERE gv.MAGV=ltc.MAGV),
         DADANGKY=(select COUNT(*) from DANGKY dk where dk.MALTC = ltc.MALTC and (dk.HUYDANGKY =0 or dk.HUYDANGKY is null))
  from LOPTINCHI ltc
 WHERE ltc.NIENKHOA = @Nienkhoa and ltc.HOCKY = @Hocky and ltc.HUYLOP = 0 and 
 @MaSV in (select MASV from DANGKY where MALTC =ltc.MALTC and (HUYDANGKY =0 or HUYDANGKY is null))
END
GO
/****** Object:  StoredProcedure [dbo].[SP_GET_LISTLOPTINCHI_DKI]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_GET_LISTLOPTINCHI_DKI]
@Nienkhoa nchar(9),
@Hocky int,
@MaSV nchar(10)
as
BEGIN
	
select  MALTC,MAMH,TENMH=(select TENMH from MONHOC a where a.MAMH=ltc.MAMH),
		NHOM=ltc.NHOM, GIANGVIEN=(SELECT gv.HO+' '+gv.TEN FROM GIANGVIEN gv WHERE gv.MAGV=ltc.MAGV),
         DADANGKY=(select COUNT(*) from DANGKY dk where dk.MALTC = ltc.MALTC and (dk.HUYDANGKY =0 or dk.HUYDANGKY is null))
  from LOPTINCHI ltc
 WHERE ltc.NIENKHOA = @Nienkhoa and ltc.HOCKY = @Hocky and ltc.HUYLOP = 0 and 
 @MaSV not in (select MASV from DANGKY where MALTC =ltc.MALTC and (HUYDANGKY =0 or HUYDANGKY is null))
END
GO
/****** Object:  StoredProcedure [dbo].[SP_GET_MONHOC]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_GET_MONHOC] @NIENKHOA varchar(9), @HOCKI int
as select a.MAMH,TENMH FROM LOPTINCHI a join (Select MAMH,TENMH from MONHOC) b on a.MAMH=b.MAMH
		 where  a.NIENKHOA= @NIENKHOA AND a.HOCKY = @HOCKI  group by a.MAMH,TENMH
GO
/****** Object:  StoredProcedure [dbo].[SP_GET_NHOM]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_GET_NHOM] 
@NIENKHOA varchar(9), @HOCKI int, @MAMH nchar(10)
as 
	select NHOM FROM LOPTINCHI 
	where @NIENKHOA = NIENKHOA AND HOCKY = @HOCKI AND MAMH = @MAMH 
	group by NHOM
GO
/****** Object:  StoredProcedure [dbo].[SP_GET_NIENKHOA]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

create proc [dbo].[SP_GET_NIENKHOA] as 
select NIENKHOA from LOPTINCHI group by NIENKHOA
GO
/****** Object:  StoredProcedure [dbo].[SP_GET_THONGTINSINHVIEN]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[SP_GET_THONGTINSINHVIEN]
@MASV nchar(10)
as
if exists (select 1 from SINHVIEN a where a.MASV=@MASV)
	BEGIN 
		select MASV,HOTEN=HO+' '+TEN,MALOP from SINHVIEN
		where MASV=@MASV
		return 1;
	END
ELSE
BEGIN
	raiserror('Sinh Vien Không Tồn Tại',16,1);
	return 0;
END
GO
/****** Object:  StoredProcedure [dbo].[SP_GETDIEMSV]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_GETDIEMSV]
@MASV nchar(10)
AS
BEGIN
select NKHK=N'Học Kỳ '+ CAST(ltc.HOCKY as nvarchar(1))+N' - Năm học '+ltc.NIENKHOA,dk.MALTC,mh.TENMH,dk.DIEM_CC,dk.DIEM_GK,dk.DIEM_CK 
from DANGKY dk JOIN (select MALTC, NIENKHOA, HOCKY,MAMH FROM LOPTINCHI) ltc on dk.MALTC=ltc.MALTC 
				 JOIN (select MAMH,TenMH FROM MONHOC) mh ON ltc.MAMH = mh.MAMH
where dk.MASV=@MASV and( HUYDANGKY=0 or HUYDANGKY is NULL)
END
GO
/****** Object:  StoredProcedure [dbo].[SP_GETMAKHOA]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_GETMAKHOA]
AS
BEGIN 
    select MaKhoa from Khoa
END
GO
/****** Object:  StoredProcedure [dbo].[SP_HUY_DKY_LTC]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_HUY_DKY_LTC]
@MALTC int,
@MASV nchar(10)
AS
BEGIN 
  IF EXISTS ( SELECT * FROM DANGKY WHERE MALTC=@MALTC AND MASV=@MASV AND (HUYDANGKY=0 OR HUYDANGKY is null))
    BEGIN 
		UPDATE DANGKY 
		SET HUYDANGKY=1
		WHERE MALTC=@MALTC AND MASV=@MASV
	END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_REPORT_BANGDIEM_TONGKETCUOIKHOA_LOP]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_REPORT_BANGDIEM_TONGKETCUOIKHOA_LOP]
	@MALOP NCHAR(10)
	as
		SELECT DK.MASV, HOTEN,TENMH, DIEM= ROUND(MAX(DIEM_CC*0.1+DIEM_GK*0.3+DIEM_CK*0.6),1) 
		FROM  (SELECT MASV, HOTEN=HO+' '+TEN FROM SINHVIEN WHERE MALOP=@MALOP) SV,
						DANGKY DK, (SELECT MALTC, a.MAMH, TENMH FROM LOPTINCHI a, MONHOC b WHERE a.MAMH=b.MAMH) LTC
		WHERE DK.MASV=SV.MASV AND DK.MALTC=LTC.MALTC
		GROUP BY DK.MASV, HOTEN, MAMH, TENMH
		ORDER BY DK.MASV
GO
/****** Object:  StoredProcedure [dbo].[SP_REPORT_BANGDIEMMONHOC]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create PROC [dbo].[SP_REPORT_BANGDIEMMONHOC]
@NienKhoa nchar(9), @HocKy int, @Nhom int,@MonHoc nchar(10)
AS

BEGIN
	declare @MALTC int
	select @MALTC= MALTC 
	from LOPTINCHI ltc
	where ltc.NIENKHOA = @NienKhoa AND ltc.HOCKY = @HocKy AND ltc.NHOM = @Nhom 
			AND ltc.MAMH= @MonHoc
	select a.MASV,HO,TEN,DIEM_CC,DIEM_GK,DIEM_CK
	from DANGKY a join (select MASV,HO,TEN from SINHVIEN) b 
				on a.MASV= b.MASV
	where a.MALTC=@MALTC and  (a.HUYDANGKY =0 or a.HUYDANGKY is NULL)
END
GO
/****** Object:  StoredProcedure [dbo].[SP_REPORT_DS_DANGKY_LOPTINCHI]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_REPORT_DS_DANGKY_LOPTINCHI]
@NienKhoa nchar(9), @HocKy int, @Nhom int,@MonHoc nchar(10)
AS

BEGIN
	declare @MALTC int
	select @MALTC= MALTC 
	from LOPTINCHI ltc
	where ltc.NIENKHOA = @NienKhoa AND ltc.HOCKY = @HocKy AND ltc.NHOM = @Nhom 
			AND ltc.MAMH= @MonHoc
	select a.MASV,HO,TEN,PHAI,MALOP
				from (select MASV from DANGKY where MALTC=@MALTC) a 
				join (select MASV,HO,TEN,IIF(PHAI='0', 'Nam', N'Nữ')as PHAI,MALOP from SINHVIEN) b 
				on a.MASV= b.MASV
END
GO
/****** Object:  StoredProcedure [dbo].[SP_REPORT_DS_LOPTINCHI]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE proc [dbo].[SP_REPORT_DS_LOPTINCHI]
@Nienkhoa nchar(9),
@Hocky int
as
BEGIN
	
select  TENMH=(select TENMH from MONHOC a where a.MAMH=ltc.MAMH),
		NHOM=ltc.NHOM, GIANGVIEN=(SELECT gv.HO+' '+gv.TEN FROM GIANGVIEN gv WHERE gv.MAGV=ltc.MAGV),
        ltc.SOSVTOITHIEU, DADANGKY=(select COUNT(*) from DANGKY dk where dk.MALTC = ltc.MALTC and (dk.HUYDANGKY =0 or dk.HUYDANGKY is null))
  from LOPTINCHI ltc
 WHERE ltc.NIENKHOA = @Nienkhoa and ltc.HOCKY = @Hocky and ltc.HUYLOP = 0 
 order by TENMH, NHOM
END
GO
/****** Object:  StoredProcedure [dbo].[SP_REPORT_HOCPHI]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_REPORT_HOCPHI] @MALOP nchar(10), @nienkhoa nchar(9), @hocky int AS
  BEGIN
	
	IF EXISTS (SELECT 1 FROM SINHVIEN JOIN HOCPHI ON HOCPHI.MASV = SINHVIEN.MASV 
	    where SINHVIEN.MALOP = @MALOP and HOCPHI.NIENKHOA = @nienkhoa and HOCPHI.HOCKY = @hocky)
		BEGIN
			select SV.HOTEN, HP.HOCPHI, HP.sotiendadong
				from  ( SELECT MASV, SINHVIEN.HO+' '+SINHVIEN.TEN AS HOTEN
				FROM SINHVIEN
				WHERE MALOP = @MALOP) SV 
			JOIN (select HOCPHI.MASV,HOCPHI.HOCPHI, SUM(CT_DONGHOCPHI.SOTIENDONG)as sotiendadong
				from  HOCPHI LEFT OUTER join CT_DONGHOCPHI  on  CT_DONGHOCPHI.MASV = HOCPHI.MASV 
				where HOCPHI.NIENKHOA = @nienkhoa and HOCPHI.HOCKY = @hocky
				group by HOCPHI.MASV,HOCPHI.HOCPHI) HP ON HP.MASV = SV.MASV
				return 1

		END
		
	else 

		BEGIN
		   RAISERROR('Không có thông tin về học phí bạn tìm',16,2);
		   return 0;
		END 
  end
GO
/****** Object:  StoredProcedure [dbo].[SP_REPORT_PHIEUDIEM]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_REPORT_PHIEUDIEM] @MASV nchar(10) AS 
BEGIN
	if exists (select 1 from SINHVIEN a where a.MASV=@MASV)
		BEGIN
			select tmp.TENMH, DIEM= MAX(DIEM_CC*0.1+DIEM_GK*0.3+DIEM_CK*0.6)
			 from (SELECT MALTC, DIEM_CC, DIEM_CK, DIEM_GK FROM DANGKY WHERE  MASV= @MASV AND (DANGKY.HUYDANGKY =0 or DANGKY.HUYDANGKY is null ) ) DK
			  join (select LOPTINCHI.MALTC, MONHOC.TENMH
					from LOPTINCHI join MONHOC on LOPTINCHI.MAMH = MONHOC.MAMH
					where LOPTINCHI.HUYLOP = 0 ) as tmp on dk.MALTC = tmp.MALTC
			group by tmp.TENMH
			ORDER BY tmp.TENMH
		END
	Else
		BEGIN
			raiserror('Sinh Vien Không Tồn Tại',16,1);
		return 0;
END
END
GO
/****** Object:  StoredProcedure [dbo].[SP_SEARCH_LTC]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_SEARCH_LTC] @NienKhoa nchar(9), @HocKy int, @Nhom int,@MonHoc nchar(10)
as
BEGIN
declare @LOPTINCHI int
select @LOPTINCHI= MALTC
from LOPTINCHI JOIN MONHOC ON LOPTINCHI.MAMH = MONHOC.MAMH
where LOPTINCHI.NIENKHOA = @NienKhoa AND LOPTINCHI.HOCKY = @HocKy AND LOPTINCHI.NHOM = @Nhom
AND MONHOC.MAMH = @MonHoc 

select MALTC, MONHOC.TENMH, HOTEN=GIANGVIEN.HO+' '+GIANGVIEN.TEN
from  MONHOC JOIN (LOPTINCHI JOIN GIANGVIEN ON LOPTINCHI.MAGV = GIANGVIEN.MAGV) ON LOPTINCHI.MAMH = MONHOC.MAMH
where LOPTINCHI.MALTC =  @LOPTINCHI

END
GO
/****** Object:  StoredProcedure [dbo].[SP_TAOLOGIN]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP_TAOLOGIN]
  @LGNAME VARCHAR(50),
  @PASS VARCHAR(50),
  @USERNAME VARCHAR(50),
  @ROLE VARCHAR(50)
AS
  DECLARE @RET INT
  EXEC @RET= SP_ADDLOGIN @LGNAME, @PASS,'QLDSV_TC'
  IF (@RET =1)  -- LOGIN NAME BI TRUNG
     RETURN 1
 
  EXEC @RET= SP_GRANTDBACCESS @LGNAME, @USERNAME
  IF (@RET =1)  -- USER  NAME BI TRUNG
  BEGIN
       EXEC SP_DROPLOGIN @LGNAME
       RETURN 2
  END
  EXEC sp_addrolemember @ROLE, @USERNAME
    EXEC sp_addsrvrolemember @LGNAME, 'SecurityAdmin'
    /*EXEC sp_addsrvrolemember @LGNAME, 'ProcessAdmin'*/
RETURN 0
GO
/****** Object:  StoredProcedure [dbo].[SP_UPDATEDIEM]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE proc [dbo].[SP_UPDATEDIEM]
@DIEMTHI TYPE_DANGKY READONLY 
AS 
BEGIN 
	MERGE INTO DANGKY AS TARGET
	USING (SELECT MALTC, MASV, DIEM_CC, DIEM_GK, DIEM_CK FROM @DIEMTHI) AS SOURCE
	ON TARGET.MALTC = SOURCE.MALTC AND TARGET.MASV = SOURCE.MASV 
	WHEN MATCHED THEN
		UPDATE SET TARGET.DIEM_CC = SOURCE.DIEM_CC,
				   TARGET.DIEM_GK = SOURCE.DIEM_GK,
				   TARGET.DIEM_CK = SOURCE.DIEM_CK
	WHEN NOT MATCHED THEN 
		INSERT ( MALTC, MASV, DIEM_CC, DIEM_GK, DIEM_CK)
		 VALUES (SOURCE.MALTC, SOURCE.MASV, SOURCE.DIEM_CC, SOURCE.DIEM_GK, SOURCE.DIEM_CK);
END 
GO
/****** Object:  StoredProcedure [dbo].[SP3_ADD_HOCPHI]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP3_ADD_HOCPHI]
@MASV NCHAR(10),@NIENKHOA NCHAR(9), @HOCKY INT,@HOCPHI INT
AS
	IF NOT EXISTS (SELECT 1 FROM HOCPHI WHERE MASV=@MASV AND NIENKHOA=@NIENKHOA AND HOCKY=@HOCKY)
		BEGIN
			INSERT INTO HOCPHI(MASV,NIENKHOA,HOCKY,HOCPHI)
			VALUES(@MASV,@NIENKHOA,@HOCKY,@HOCPHI)
		END
	ELSE
	  RAISERROR('Sinh Viên Đã Có Thông Tin Học Phí Học Kỳ Này!',16,1)
GO
/****** Object:  StoredProcedure [dbo].[SP3_DELETE_HOCPHI]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP3_DELETE_HOCPHI]
@MASV NCHAR(10),@NIENKHOA NCHAR(9), @HOCKY INT
AS
	IF EXISTS (SELECT 1 FROM CT_DONGHOCPHI WHERE MASV=@MASV AND NIENKHOA=@NIENKHOA AND HOCKY=@HOCKY)
		BEGIN

			RAISERROR('Sinh Viên Đã Đóng Học Phí! Không Thể Xóa!',16,1)
		END
	ELSE
	  BEGIN
			DELETE  FROM HOCPHI
			WHERE MASV=@MASV AND NIENKHOA=@NIENKHOA AND HOCKY=@HOCKY
	  END
GO
/****** Object:  StoredProcedure [dbo].[SP3_GET_CTDONG_HOCPHI]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP3_GET_CTDONG_HOCPHI]
@MASV NCHAR(10),@NIENKHOA NCHAR(9), @HOCKY INT
AS
	BEGIN 
		SELECT NGAYDONG,SOTIENDONG FROM CT_DONGHOCPHI
		WHERE MASV=@MASV AND NIENKHOA=@NIENKHOA AND @HOCKY=HOCKY
	END

GO
/****** Object:  StoredProcedure [dbo].[SP3_GETKHOA_BYLOP]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[SP3_GETKHOA_BYLOP] @malop nchar(10) as
begin 
	select KHOA.TENKHOA
	from LOP join KHOA on LOP.MAKHOA = KHOA.MAKHOA
	where LOP.MALOP = @malop
end
GO
/****** Object:  StoredProcedure [dbo].[SP3_SAVE_DONG_HOCPHI]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP3_SAVE_DONG_HOCPHI]
@MASV NCHAR(10),@NIENKHOA NCHAR(9), @HOCKY INT,
@NGAYDONG date,@SOTIENDONG INT
AS
	IF EXISTS (SELECT 1 FROM CT_DONGHOCPHI WHERE MASV=@MASV AND NIENKHOA=@NIENKHOA AND HOCKY=@HOCKY AND @NGAYDONG =NGAYDONG)
		RAISERROR('Sinh Viên đã đóng học phí trong thơi gian này! \n Vui lòng kiểm tra lại',16,1)
	ELSE 
	    BEGIN
			INSERT INTO CT_DONGHOCPHI(MASV,NIENKHOA,HOCKY,NGAYDONG,SOTIENDONG)
			VALUES(@MASV,@NIENKHOA,@HOCKY,@NGAYDONG,@SOTIENDONG)
		END
GO
/****** Object:  StoredProcedure [dbo].[SP3_UPDATE_HOCPHI]    Script Date: 5/17/2022 1:45:29 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[SP3_UPDATE_HOCPHI]
@MASV NCHAR(10),@NIENKHOA NCHAR(9), @HOCKY INT,@HOCPHI INT
AS
	IF EXISTS (SELECT 1 FROM CT_DONGHOCPHI WHERE MASV=@MASV AND NIENKHOA=@NIENKHOA AND HOCKY=@HOCKY)
		BEGIN
			RAISERROR('Sinh Viên Đã Đóng Học Phí! Không Thể Sửa!',16,1)
		END
	ELSE
			UPDATE HOCPHI
			SET HOCPHI=@HOCPHI
			WHERE MASV=@MASV AND NIENKHOA=@NIENKHOA AND HOCKY=@HOCKY
GO
